/*
 *----------------------------------------------------------------------
 *    T-Kernel 2.0 Software Package
 *
 *    Copyright 2011 by T-Engine Forum
 *    This software is distributed under the T-License 2.0.
 *----------------------------------------------------------------------
 *
 *    Released by T-Engine Forum(http://www.t-engine.org/) at 2011/05/17.
 *    Last modified at 2012/11/30 by T-Engine Forum.
 *
 *----------------------------------------------------------------------
 */

==============================================================================
        T-Engineリファレンスボード用T-Kernel 2.0とEclipse開発環境
==============================================================================

------------------------------------------------------------------------------
 目次
------------------------------------------------------------------------------
  1. はじめに
  2. パッケージ内容
    2.1 ターゲット用のソフトウェア
    2.2 開発環境
    2.3 エミュレータ
  3. リリースファイル
    3.1 T-Kernelソースコードパッケージ [*srcpkg*]
    3.2 ターゲット関連情報
    3.3 開発環境
    3.4 エミュレータ
  4. 作業の流れ
    4.1 開発環境のインストール
    4.2 T-Kernelソースコードパッケージの展開
    4.3 エミュレータでの実行
    4.4 T-Monitorの構築と実機ROMへの書き込み
    4.5 T-Kernelの構築と実行、デバッグ
    4.6 デバイスドライバの構築
    4.7 アプリケーションの構築と実行、デバッグ
    4.8 ROM化

------------------------------------------------------------------------------
1. はじめに
------------------------------------------------------------------------------

本書は、EclipseあるいはLinuxコマンドラインの開発環境を使用して、T-Engineリファ
レンスボード(tef_em1d)用のT-Monitor、T-Kernel 2.0、デバイスドライバ、およびそ
れらの上で動くアプリケーションを構築し、実機での実行やデバッグを行う際の手順を
説明する文書です。

T-Kernelを使ったシステムを構築するには、本文書とともに提供されるパッケージ(本
パッケージ)のほかに、T-Kernelソースコードのパッケージ(tkernel_source.tar.gz)が
必要です。T-Kernelソースコードのパッケージは、T-EngineフォーラムのT-Kernel
トレーサビリティサービスに登録されており、そこから入手できます。また、T-Kernel
ソースコードのパッケージは、T-License 2.0の適用対象となります。

以下では、本パッケージの内容とT-Kernelソースコードのパッケージの内容を合わせて
説明します。なお、この中でT-Kernelソースコードのパッケージに含まれる内容には
[*srcpkg*] を付けています。

------------------------------------------------------------------------------
2. パッケージ内容
------------------------------------------------------------------------------

--------------------------------------------------
2.1 ターゲット用のソフトウェア
--------------------------------------------------

次のソフトウェアのソースコードとビルド環境が含まれています。

        ・T-Kernel 2.0          [*srcpkg*]
        ・T-Monitor             [*srcpkg*]
        ・デバイスドライバ      [*srcpkg*]
              - 時計 (RTC)
              - シリアルコンソール
              - タッチパネルおよび押しボタンスイッチ
              - LCD
              - システムディスク(microSD用)

  ※ システムディスク(microSD用)のデバイスドライバの一部は、ソースコードではな
     くオブジェクトコードが含まれます。

--------------------------------------------------
2.2 開発環境
--------------------------------------------------

次のソフトウェアが含まれています。

        ・Eclipse＋Cygwin用のGNU開発環境 (Windows上で動作)
        ・Linuxコマンドライン用のGNU開発環境

--------------------------------------------------
2.3 エミュレータ
--------------------------------------------------

次のソフトウェアが含まれています。

        ・T-Engine リファレンスボード(tef_em1d)用エミュレータ(QEMU-tef_em1d)

詳細については、「エミュレータ (QEMU-tef_em1d) 説明書」readme.txt を参照してく
ださい。

------------------------------------------------------------------------------
3. リリースファイル
------------------------------------------------------------------------------

--------------------------------------------------
3.1 T-Kernelソースコードパッケージ [*srcpkg*]
--------------------------------------------------

(1) 説明書

  ReadMe.txt                    リリース説明書 (本書)
  tk2-dist-ucode.png            ディストリビューションucode
  TEF000-215-120911.pdf         T-License 2.0

  srcpkg/doc/ja/
    tkernel.txt                 T-Kernel 2.0ソースコード説明書
    tmonitor.txt                T-Monitor構築説明書(tef_em1d用)
    driver.txt                  デバイスドライバ構築説明書(tef_em1d用)
    impl-tef_em1d.txt           tef_em1d実装仕様書
    gcc_setup_guide_linux.txt   GNU開発環境・インストール手順(Linux)
    gcc_setup_guide_cygwin.txt  GNU開発環境・インストール手順(Cygwin)
    eclipse_setup_guide.txt     Eclipse開発環境・インストール手順
    eclipse_guide.txt           EclipseによるT-Kernel構築説明書(tef_em1d用)

(2) ソースコード

  srcpkg/
    tkernel_source.tar.gz      ソースコードパッケージ
                                (T-Kernel,T-Monitor,デバイスドライバ)

(3) 実行用バイナリ

  srcpkg/bin/
    tmonitor.mot                T-Monitor ROMイメージ
    rominfo.mot                 ROM情報(ROMInfo)のROMイメージ
    kernel-rom.mot              T-Kernel ROMイメージ

  ※ kernel-rom.mot は、デバイスドライバを組み込まない状態で構築した T-Kernel 2.
     0 の ROM イメージです。

--------------------------------------------------
3.2 ターゲット関連情報
--------------------------------------------------

  hardware/tef_em1d/doc/ja/
    TE_ReferenceBoard_HardwareManual.pdf
                                リファレンスボードハードウェアマニュアル
    target.txt                  実機への転送と動作確認手順(tef_em1d用)

  hardware/tef_em1d/ice/
    JETARM.CFG                  PARTNER-Jet用ICE設定ファイル

--------------------------------------------------
3.3 開発環境
--------------------------------------------------

  develop/
    te.Linux-i686.arm_2.1.0.3.tar.gz    GNU開発環境・CPU 依存部分(Linux)
    te.Linux-i686.common.13.tar.gz      GNU開発環境・共通部分(Linux)

    cygwin_d-1.7.7-1.zip                Cygwinインストールパッケージ

    te.Cygwin-i686.arm_2.1.0.3.tar.gz   GNU開発環境・CPU依存部分(Cygwin)
    te.Cygwin-i686.common.13.tar.gz     GNU開発環境・共通部分(Cygwin)

    eclipse-cpp-indigo-SR2-incubation-win32.zip
                                        Eclipse+CDT パッケージ
    pleiades_1.3.4.zip                  Eclipse 日本語化プラグイン
    org.t_engine.te.1.1.0.zip           Eclipse T-Kernel共通プラグイン
    org.t_engine.tl.tef_em1d.1.1.0.zip  Eclipse tef_em1d用プラグイン

【GNUツールについて】
   ・gcc,gdbなどのGNUツールの原版の入手先は http://www.gnu.org/software/ です。
     本開発環境で使用しているGNUツールは、この原版に対して一部パッチを当てて生
     成しています。パッチの入手方法については、別途お知らせします。
   ・GNUツールのライセンスはGPLです。詳細は http://www.gnu.org/licenses/gpl.
     html をご覧ください。

【Cygwinについて】
   ・Cygwinの入手先は http://www.cygwin.com/ です。本パッケージに含まれている
     Cygwinは、ここから入手した動作確認済みのバージョンのものです。
   ・CygwinのライセンスはGPLです。詳細は http://cygwin.com/license.html をご覧
     ください。

【Eclipseについて】
   ・Eclipseの入手先は http://www.eclipse.org/ です。本パッケージに含まれてい
     るEclipseは、ここから入手した動作確認済みのバージョンのものです。
   ・Eclipseには、Eclipse Public Lincense(EPL)と呼ばれるライセンスが適用されま
     す。詳細は http://www.eclipse.org/legal/epl-v10.htmlをご覧ください。
   ・Eclipse 日本語化プラグインには、Eclipse Public License(EPL)、Mozilla 
     Public License(MPL)、Lesser General Public License(LGPL)、Apache License
     と呼ばれるライセンスが適用されます。詳細は http://mergedoc.sourceforge.
     jp/index.html#/pleiades.html をご覧ください。

--------------------------------------------------
3.4 エミュレータ
--------------------------------------------------

  emulator/                             エミュレータ関連ファイル

------------------------------------------------------------------------------
4. 作業の流れ
------------------------------------------------------------------------------

各プログラムの構築(ビルド)から実機での実行やデバッグを行うまでの、全般的な作業
の流れを、順を追って説明します。

--------------------------------------------------
4.1 開発環境のインストール
--------------------------------------------------

開発用ホストPCに、以下のいずれかの開発環境をインストールします。

(1) Eclipseで開発する場合

EclipseはWindows上で利用できます。Eclipseでの開発にはCygwinが必要ですので、最
初にCygwinをインストールした後に、Eclipseをインストールします。以下のマニュア
ルをこの順に参照して、開発環境のインストールを行ってください。

    gcc_setup_guide_cygwin.txt  GNU開発環境・インストール手順(Cygwin)
    eclipse_setup_guide.txt     Eclipse開発環境・インストール手順

Eclipseの使用方法については、「EclipseによるT-Kernel構築説明書」eclipse_guide.
txt を参照してください。また、「3. プログラムのビルド方法」「3.1 一般的なビル
ド方法」の説明も一読しておいてください。

(2) Linuxコマンドラインで開発する場合

「GNU開発環境・インストール手順(Linux)」gcc_setup_guide_linux.txt を参照して開
発環境のインストールを行ってください。

--------------------------------------------------
4.2 T-Kernelソースコードパッケージの展開
--------------------------------------------------

/usr/local/tef_em1d (EclipseとCygwinを利用する場合は c:\cygwin\usr\local\
tef_em1d) の下で、T-Kernelソースコードのパッケージ(tkernel_source.tar.gz)を展
開してください。

Eclipseで開発する場合は、この時点で、「EclipseによるT-Kernel構築説明書」
eclipse_guide.txt の「2. Eclipseの起動とワークスペースの設定」までの作業を行っ
ておいてください。

--------------------------------------------------
4.3 エミュレータでの実行
--------------------------------------------------
本パッケージには、T-Engineリファレンスボード(tef_em1d)に対応したエミュレータが
含まれています。このエミュレータを利用することで、T-Engineリファレンスボードが
無い状態でも、T-Kernel 2.0ベースのアプリケーションをWindows PC上で開発できるよ
うになります。

「T-Engine リファレンスボード (tef_em1d) 用 エミュレータ (QEMU-tef_em1d) 説明書」
emulator/tef_em1d/readme.txt の以下の章の説明に従って、エミュレータのインストー
ルと動作確認、Eclipseの設定を行ってください。

    1. QEMU-tef_em1d のインストール
    2. QEMU-tef_em1d の実行
    4. QEMU-tef_em1d 用でのデバッグ (Eclipse)

--------------------------------------------------
4.4 T-Monitorの構築と実機ROMへの書き込み
--------------------------------------------------

実機のFlash ROM上でT-Monitorを動かすことにより、ICEを使用しなくても、T-Kernel
などのプログラムを実機に転送して実行できるようになります。したがって、まずはT-
Monitorを実機のFlash ROMに書き込む必要があります。

T-Monitorをソースコードからコンパイルして構築する場合は、「T-Monitor構築説明書」
tmonitor.txt を参照して、T-MonitorのオブジェクトのROMイメージであるtmonitor.
motを生成してください。

また、T-Kernelソースコードのパッケージの中には、T-Engineリファレンスボード
(tef_em1d)用に既に構築済のtmonitor.motが入っていますので、はじめからこれを利用
することもできます。

tmonitor.motを実機に書き込む手順については、「実機への転送と動作確認手順
(tef_em1d用)」target.txtを参照してください。Flash ROMにT-Monitorが書き込まれて
いない状態から、最初にT-Monitorを書き込むには、ICEを使用する必要があります。

--------------------------------------------------
4.5 T-Kernelの構築と実行、デバッグ
--------------------------------------------------

続いて、T-Kernel本体を構築し、実機への転送と実行、デバッグを行います。

Eclipseを使う場合の手順は、「EclipseによるT-Kernel構築説明書」eclipse_guide.
txtの「3.2 ライブラリのビルド」「3.3 RAMロード用カーネルのビルド」「3.4 RAMロ
ード用設定情報ファイルのビルド」「4. 実行とデバッグ」を参照してください。この
場合は、Eclipseによるデバッグを考慮し、RAM上にロードして実行するT-Kernelを構築
します。なお、この前にT-Monitorの構築を行っていた場合、「3.2 ライブラリのビル
ド」の作業は済んでいるはずですので、ここでは不要です。

Linuxコマンドラインを使う場合の手順は、「T-Kernel 2.0ソースコード説明書」
tkernel.txtの「2. T-Kernelの構築と実機上での動作確認」を参照してください。この
場合は、ROMに書き込んで実行するT-Kernelを構築します。

--------------------------------------------------
4.6 デバイスドライバの構築
--------------------------------------------------

デバイスドライバはT-Kernelとリンクされ、実行時には1つのオブジェクトになります。
したがって、T-Kernelとともにデバイスドライバを動かす場合は、まずデバイス毎のデ
バイスドライバのリロケータブルオブジェクトを作成し、それらのオブジェクトとT-
Kernelをリンクして、実行用のオブジェクトコードを構築します。

具体的な手順については、「デバイスドライバ構築説明書」driver.txtの「2. デバイ
スドライバの構築方法」を参照してください。

--------------------------------------------------
4.7 アプリケーションの構築と実行、デバッグ
--------------------------------------------------

ユーザアプリケーションについても、T-Kernelとリンクされ、実行時には1つのオブジ
ェクトになります。通常は、T-Kernelソースコード内のusermainのプログラムに書き替
えや追加を行う形で、アプリケーションプログラムを記述します。詳細については、
「T-Kernel 2.0ソースコード説明書」tkernel.txtの「4.4 kernelディレクトリのアプ
リケーション依存部」を参照してください。

デバイスドライバも一緒に動かす場合は、usermainの代わりにusermain_drvを使用しま
す。「デバイスドライバ構築説明書」driver.txtの「2.8 デバイスドライバを含むT-
Kernel本体のビルド」を参照してください。

アプリケーションやデバイスドライバを含めて構築されたT-Kernelの実行やデバッグの
手順は、T-Kernel単体の場合(デバイスドライバやアプリケーションの無い場合)と同じ
です。上記の「4.4 T-Kernelの構築と実行、デバッグ」を参照してください。

--------------------------------------------------
4.8 ROM化
--------------------------------------------------

Eclipseを使用したデバッグの終了後に、アプリケーションやデバイスドライバとリン
クされたT-KernelのオブジェクトコードをROM化する場合は、Flash ROM上に書かれてい
る設定情報ファイル(config)を変更する必要があります。この場合の具体的な手順につ
いては、「EclipseによるT-Kernel構築説明書」eclipse_guide.txtの「5. ROM書き込み
用プログラムのビルド」を参照してください。

以上
